var us=Object.defineProperty;var cs=(oe,z,ce)=>z in oe?us(oe,z,{enumerable:!0,configurable:!0,writable:!0,value:ce}):oe[z]=ce;var U=(oe,z,ce)=>cs(oe,typeof z!="symbol"?z+"":z,ce);(function(){"use strict";var oe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},z={},ce;function dr(){return ce||(ce=1,function(e,t){if(e.setImmediate)return;var n=1,r={},i=!1,s=e.document,a;function o(h){typeof h!="function"&&(h=new Function(""+h));for(var _=new Array(arguments.length-1),A=0;A<_.length;A++)_[A]=arguments[A+1];var w={callback:h,args:_};return r[n]=w,a(n),n++}function c(h){delete r[h]}function f(h){var _=h.callback,A=h.args;switch(A.length){case 0:_();break;case 1:_(A[0]);break;case 2:_(A[0],A[1]);break;case 3:_(A[0],A[1],A[2]);break;default:_.apply(t,A);break}}function d(h){if(i)setTimeout(d,0,h);else{var _=r[h];if(_){i=!0;try{f(_)}finally{c(h),i=!1}}}}function g(){a=function(h){process.nextTick(function(){d(h)})}}function p(){if(e.postMessage&&!e.importScripts){var h=!0,_=e.onmessage;return e.onmessage=function(){h=!1},e.postMessage("","*"),e.onmessage=_,h}}function b(){var h="setImmediate$"+Math.random()+"$",_=function(A){A.source===e&&typeof A.data=="string"&&A.data.indexOf(h)===0&&d(+A.data.slice(h.length))};e.addEventListener?e.addEventListener("message",_,!1):e.attachEvent("onmessage",_),a=function(A){e.postMessage(h+A,"*")}}function P(){var h=new MessageChannel;h.port1.onmessage=function(_){var A=_.data;d(A)},a=function(_){h.port2.postMessage(_)}}function O(){var h=s.documentElement;a=function(_){var A=s.createElement("script");A.onreadystatechange=function(){d(_),A.onreadystatechange=null,h.removeChild(A),A=null},h.appendChild(A)}}function E(){a=function(h){setTimeout(d,0,h)}}var y=Object.getPrototypeOf&&Object.getPrototypeOf(e);y=y&&y.setTimeout?y:e,{}.toString.call(e.process)==="[object process]"?g():p()?b():e.MessageChannel?P():s&&"onreadystatechange"in s.createElement("script")?O():E(),y.setImmediate=o,y.clearImmediate=c}(typeof self>"u"?typeof oe>"u"?z:oe:self)),z}dr();function X(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+e+(n.length?" "+n.map(function(i){return"'"+i+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function ge(e){return!!e&&!!e[W]}function le(e){var t;return!!e&&(function(n){if(!n||typeof n!="object")return!1;var r=Object.getPrototypeOf(n);if(r===null)return!0;var i=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return i===Object||typeof i=="function"&&Function.toString.call(i)===br}(e)||Array.isArray(e)||!!e[rn]||!!(!((t=e.constructor)===null||t===void 0)&&t[rn])||Ze(e)||Qe(e))}function Ae(e,t,n){n===void 0&&(n=!1),ye(e)===0?(n?Object.keys:dt)(e).forEach(function(r){n&&typeof r=="symbol"||t(r,e[r],e)}):e.forEach(function(r,i){return t(i,r,e)})}function ye(e){var t=e[W];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:Ze(e)?2:Qe(e)?3:0}function Xe(e,t){return ye(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function fr(e,t){return ye(e)===2?e.get(t):e[t]}function Yt(e,t,n){var r=ye(e);r===2?e.set(t,n):r===3?e.add(n):e[t]=n}function hr(e,t){return e===t?e!==0||1/e==1/t:e!=e&&t!=t}function Ze(e){return yr&&e instanceof Map}function Qe(e){return mr&&e instanceof Set}function de(e){return e.o||e.t}function et(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=Er(e);delete t[W];for(var n=dt(t),r=0;r<n.length;r++){var i=n[r],s=t[i];s.writable===!1&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(t[i]={configurable:!0,writable:!0,enumerable:s.enumerable,value:e[i]})}return Object.create(Object.getPrototypeOf(e),t)}function tt(e,t){return t===void 0&&(t=!1),nt(e)||ge(e)||!le(e)||(ye(e)>1&&(e.set=e.add=e.clear=e.delete=pr),Object.freeze(e),t&&Ae(e,function(n,r){return tt(r,!0)},!0)),e}function pr(){X(2)}function nt(e){return e==null||typeof e!="object"||Object.isFrozen(e)}function Q(e){var t=Or[e];return t||X(18,e),t}function qt(){return Se}function rt(e,t){t&&(Q("Patches"),e.u=[],e.s=[],e.v=t)}function Le(e){it(e),e.p.forEach(vr),e.p=null}function it(e){e===Se&&(Se=e.l)}function zt(e){return Se={p:[],l:Se,h:e,m:!0,_:0}}function vr(e){var t=e[W];t.i===0||t.i===1?t.j():t.g=!0}function st(e,t){t._=t.p.length;var n=t.p[0],r=e!==void 0&&e!==n;return t.h.O||Q("ES5").S(t,e,r),r?(n[W].P&&(Le(t),X(4)),le(e)&&(e=Fe(t,e),t.l||je(t,e)),t.u&&Q("Patches").M(n[W].t,e,t.u,t.s)):e=Fe(t,n,[]),Le(t),t.u&&t.v(t.u,t.s),e!==nn?e:void 0}function Fe(e,t,n){if(nt(t))return t;var r=t[W];if(!r)return Ae(t,function(o,c){return Xt(e,r,t,o,c,n)},!0),t;if(r.A!==e)return t;if(!r.P)return je(e,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var i=r.i===4||r.i===5?r.o=et(r.k):r.o,s=i,a=!1;r.i===3&&(s=new Set(i),i.clear(),a=!0),Ae(s,function(o,c){return Xt(e,r,i,o,c,n,a)}),je(e,i,!1),n&&e.u&&Q("Patches").N(r,n,e.u,e.s)}return r.o}function Xt(e,t,n,r,i,s,a){if(ge(i)){var o=Fe(e,i,s&&t&&t.i!==3&&!Xe(t.R,r)?s.concat(r):void 0);if(Yt(n,r,o),!ge(o))return;e.m=!1}else a&&n.add(i);if(le(i)&&!nt(i)){if(!e.h.D&&e._<1)return;Fe(e,i),t&&t.A.l||je(e,i)}}function je(e,t,n){n===void 0&&(n=!1),!e.l&&e.h.D&&e.m&&tt(t,n)}function at(e,t){var n=e[W];return(n?de(n):e)[t]}function Zt(e,t){if(t in e)for(var n=Object.getPrototypeOf(e);n;){var r=Object.getOwnPropertyDescriptor(n,t);if(r)return r;n=Object.getPrototypeOf(n)}}function ot(e){e.P||(e.P=!0,e.l&&ot(e.l))}function ut(e){e.o||(e.o=et(e.t))}function ct(e,t,n){var r=Ze(t)?Q("MapSet").F(t,n):Qe(t)?Q("MapSet").T(t,n):e.O?function(i,s){var a=Array.isArray(i),o={i:a?1:0,A:s?s.A:qt(),P:!1,I:!1,R:{},l:s,t:i,k:null,o:null,j:null,C:!1},c=o,f=ft;a&&(c=[o],f=Me);var d=Proxy.revocable(c,f),g=d.revoke,p=d.proxy;return o.k=p,o.j=g,p}(t,n):Q("ES5").J(t,n);return(n?n.A:qt()).p.push(r),r}function gr(e){return ge(e)||X(22,e),function t(n){if(!le(n))return n;var r,i=n[W],s=ye(n);if(i){if(!i.P&&(i.i<4||!Q("ES5").K(i)))return i.t;i.I=!0,r=Qt(n,s),i.I=!1}else r=Qt(n,s);return Ae(r,function(a,o){i&&fr(i.t,a)===o||Yt(r,a,t(o))}),s===3?new Set(r):r}(e)}function Qt(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return et(e)}var en,Se,lt=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",yr=typeof Map<"u",mr=typeof Set<"u",tn=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",nn=lt?Symbol.for("immer-nothing"):((en={})["immer-nothing"]=!0,en),rn=lt?Symbol.for("immer-draftable"):"__$immer_draftable",W=lt?Symbol.for("immer-state"):"__$immer_state",br=""+Object.prototype.constructor,dt=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,Er=Object.getOwnPropertyDescriptors||function(e){var t={};return dt(e).forEach(function(n){t[n]=Object.getOwnPropertyDescriptor(e,n)}),t},Or={},ft={get:function(e,t){if(t===W)return e;var n=de(e);if(!Xe(n,t))return function(i,s,a){var o,c=Zt(s,a);return c?"value"in c?c.value:(o=c.get)===null||o===void 0?void 0:o.call(i.k):void 0}(e,n,t);var r=n[t];return e.I||!le(r)?r:r===at(e.t,t)?(ut(e),e.o[t]=ct(e.A.h,r,e)):r},has:function(e,t){return t in de(e)},ownKeys:function(e){return Reflect.ownKeys(de(e))},set:function(e,t,n){var r=Zt(de(e),t);if(r!=null&&r.set)return r.set.call(e.k,n),!0;if(!e.P){var i=at(de(e),t),s=i==null?void 0:i[W];if(s&&s.t===n)return e.o[t]=n,e.R[t]=!1,!0;if(hr(n,i)&&(n!==void 0||Xe(e.t,t)))return!0;ut(e),ot(e)}return e.o[t]===n&&(n!==void 0||t in e.o)||Number.isNaN(n)&&Number.isNaN(e.o[t])||(e.o[t]=n,e.R[t]=!0),!0},deleteProperty:function(e,t){return at(e.t,t)!==void 0||t in e.t?(e.R[t]=!1,ut(e),ot(e)):delete e.R[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var n=de(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r&&{writable:!0,configurable:e.i!==1||t!=="length",enumerable:r.enumerable,value:n[t]}},defineProperty:function(){X(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){X(12)}},Me={};Ae(ft,function(e,t){Me[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),Me.deleteProperty=function(e,t){return Me.set.call(this,e,t,void 0)},Me.set=function(e,t,n){return ft.set.call(this,e[0],t,n,e[0])};var Pr=function(){function e(n){var r=this;this.O=tn,this.D=!0,this.produce=function(i,s,a){if(typeof i=="function"&&typeof s!="function"){var o=s;s=i;var c=r;return function(O){var E=this;O===void 0&&(O=o);for(var y=arguments.length,h=Array(y>1?y-1:0),_=1;_<y;_++)h[_-1]=arguments[_];return c.produce(O,function(A){var w;return(w=s).call.apply(w,[E,A].concat(h))})}}var f;if(typeof s!="function"&&X(6),a!==void 0&&typeof a!="function"&&X(7),le(i)){var d=zt(r),g=ct(r,i,void 0),p=!0;try{f=s(g),p=!1}finally{p?Le(d):it(d)}return typeof Promise<"u"&&f instanceof Promise?f.then(function(O){return rt(d,a),st(O,d)},function(O){throw Le(d),O}):(rt(d,a),st(f,d))}if(!i||typeof i!="object"){if((f=s(i))===void 0&&(f=i),f===nn&&(f=void 0),r.D&&tt(f,!0),a){var b=[],P=[];Q("Patches").M(i,f,b,P),a(b,P)}return f}X(21,i)},this.produceWithPatches=function(i,s){if(typeof i=="function")return function(f){for(var d=arguments.length,g=Array(d>1?d-1:0),p=1;p<d;p++)g[p-1]=arguments[p];return r.produceWithPatches(f,function(b){return i.apply(void 0,[b].concat(g))})};var a,o,c=r.produce(i,s,function(f,d){a=f,o=d});return typeof Promise<"u"&&c instanceof Promise?c.then(function(f){return[f,a,o]}):[c,a,o]},typeof(n==null?void 0:n.useProxies)=="boolean"&&this.setUseProxies(n.useProxies),typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze)}var t=e.prototype;return t.createDraft=function(n){le(n)||X(8),ge(n)&&(n=gr(n));var r=zt(this),i=ct(this,n,void 0);return i[W].C=!0,it(r),i},t.finishDraft=function(n,r){var i=n&&n[W],s=i.A;return rt(s,r),st(void 0,s)},t.setAutoFreeze=function(n){this.D=n},t.setUseProxies=function(n){n&&!tn&&X(20),this.O=n},t.applyPatches=function(n,r){var i;for(i=r.length-1;i>=0;i--){var s=r[i];if(s.path.length===0&&s.op==="replace"){n=s.value;break}}i>-1&&(r=r.slice(i+1));var a=Q("Patches").$;return ge(n)?a(n,r):this.produce(n,function(o){return a(o,r)})},e}(),$=new Pr,_r=$.produce;$.produceWithPatches.bind($),$.setAutoFreeze.bind($),$.setUseProxies.bind($),$.applyPatches.bind($),$.createDraft.bind($),$.finishDraft.bind($);class Ar{constructor(t){const n=Sr();this.c=1,this.s0=n(" "),this.s1=n(" "),this.s2=n(" "),this.s0-=n(t),this.s0<0&&(this.s0+=1),this.s1-=n(t),this.s1<0&&(this.s1+=1),this.s2-=n(t),this.s2<0&&(this.s2+=1)}next(){const t=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.s2=t-(this.c=Math.trunc(t))}}function Sr(){let e=4022871197;return function(n){const r=n.toString();for(let i=0;i<r.length;i++){e+=r.charCodeAt(i);let s=.02519603282416938*e;e=s>>>0,s-=e,s*=e,e=s>>>0,s-=e,e+=s*4294967296}return(e>>>0)*23283064365386963e-26}}function sn(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function an(e,t){const n=new Ar(e),r=n.next.bind(n);return t&&sn(t,n),r.state=()=>sn(n,{}),r}class on{constructor(t){this.state=t||{seed:"0"},this.used=!1}static seed(){return Date.now().toString(36).slice(-10)}isUsed(){return this.used}getState(){return this.state}_random(){this.used=!0;const t=this.state,n=t.prngstate?"":t.seed,r=an(n,t.prngstate),i=r();return this.state={...t,prngstate:r.state()},i}api(){const t=this._random.bind(this),n={D4:4,D6:6,D8:8,D10:10,D12:12,D20:20},r={};for(const s in n){const a=n[s];r[s]=o=>o===void 0?Math.floor(t()*a)+1:Array.from({length:o}).map(()=>Math.floor(t()*a)+1)}function i(s=6,a){return a===void 0?Math.floor(t()*s)+1:Array.from({length:a}).map(()=>Math.floor(t()*s)+1)}return{...r,Die:i,Number:()=>t(),Shuffle:s=>{const a=[...s];let o=s.length,c=0;const f=Array.from({length:o});for(;o;){const d=Math.trunc(o*t());f[c++]=a[d],a[d]=a[--o]}return f},_private:this}}}const Mr={name:"random",noClient:({api:e})=>e._private.isUsed(),flush:({api:e})=>e._private.getState(),api:({data:e})=>new on(e).api(),setup:({game:e})=>{let{seed:t}=e;return t===void 0&&(t=on.seed()),{seed:t}},playerView:()=>{}};var ht,un;function Ir(){if(un)return ht;un=1;var e="[object Object]";function t(p){var b=!1;if(p!=null&&typeof p.toString!="function")try{b=!!(p+"")}catch{}return b}function n(p,b){return function(P){return p(b(P))}}var r=Function.prototype,i=Object.prototype,s=r.toString,a=i.hasOwnProperty,o=s.call(Object),c=i.toString,f=n(Object.getPrototypeOf,Object);function d(p){return!!p&&typeof p=="object"}function g(p){if(!d(p)||c.call(p)!=e||t(p))return!1;var b=f(p);if(b===null)return!0;var P=a.call(b,"constructor")&&b.constructor;return typeof P=="function"&&P instanceof P&&s.call(P)==o}return ht=g,ht}Ir();const pt="MAKE_MOVE",Ue="GAME_EVENT",vt="REDO",gt="RESET",yt="SYNC",mt="UNDO",bt="UPDATE",Et="PATCH",cn="PLUGIN",Ke="STRIP_TRANSIENTS",ln=(e,t,n,r)=>({type:pt,payload:{type:e,args:t,playerID:n,credentials:r}}),Ie=(e,t,n,r)=>({type:Ue,payload:{type:e,args:t,playerID:n,credentials:r}}),dn=(e,t,n,r)=>({type:Ue,payload:{type:e,args:t,playerID:n,credentials:r},automatic:!0}),fn=e=>({type:yt,state:e.state,log:e.log,initialState:e.initialState,clientOnly:!0}),hn=(e,t,n,r)=>({type:Et,prevStateID:e,stateID:t,patch:n,deltalog:r,clientOnly:!0}),pn=(e,t)=>({type:bt,state:e,deltalog:t,clientOnly:!0}),vn=e=>({type:gt,state:e,clientOnly:!0}),gn=(e,t)=>({type:mt,payload:{type:null,args:null,playerID:e,credentials:t}}),yn=(e,t)=>({type:vt,payload:{type:null,args:null,playerID:e,credentials:t}}),wr=(e,t,n,r)=>({type:cn,payload:{type:e,args:t,playerID:n,credentials:r}}),mn=()=>({type:Ke});var Dr=Object.freeze({__proto__:null,makeMove:ln,gameEvent:Ie,automaticGameEvent:dn,sync:fn,patch:hn,update:pn,reset:vn,undo:gn,redo:yn,plugin:wr,stripTransients:mn});const Ot="INVALID_MOVE",Nr={name:"plugin-immer",fnWrap:e=>(t,...n)=>{let r=!1;const i=_r(t.G,s=>{const a=e({...t,G:s},...n);if(a===Ot){r=!0;return}return a});return r?Ot:i}};var L;(function(e){e.MOVE="MOVE",e.GAME_ON_END="GAME_ON_END",e.PHASE_ON_BEGIN="PHASE_ON_BEGIN",e.PHASE_ON_END="PHASE_ON_END",e.TURN_ON_BEGIN="TURN_ON_BEGIN",e.TURN_ON_MOVE="TURN_ON_MOVE",e.TURN_ON_END="TURN_ON_END"})(L||(L={}));var ne;(function(e){e.CalledOutsideHook="Events must be called from moves or the `onBegin`, `onEnd`, and `onMove` hooks.\nThis error probably means you called an event from other game code, like an `endIf` trigger or one of the `turn.order` methods.",e.EndTurnInOnEnd="`endTurn` is disallowed in `onEnd` hooks — the turn is already ending.",e.MaxTurnEndings=`Maximum number of turn endings exceeded for this update.
This likely means game code is triggering an infinite loop.`,e.PhaseEventInOnEnd="`setPhase` & `endPhase` are disallowed in a phase’s `onEnd` hook — the phase is already ending.\nIf you’re trying to dynamically choose the next phase when a phase ends, use the phase’s `next` trigger.",e.StageEventInOnEnd="`setStage`, `endStage` & `setActivePlayers` are disallowed in `onEnd` hooks.",e.StageEventInPhaseBegin="`setStage`, `endStage` & `setActivePlayers` are disallowed in a phase’s `onBegin` hook.\nUse `setActivePlayers` in a `turn.onBegin` hook or declare stages with `turn.activePlayers` instead.",e.StageEventInTurnBegin="`setStage` & `endStage` are disallowed in `turn.onBegin`.\nUse `setActivePlayers` or declare stages with `turn.activePlayers` instead."})(ne||(ne={}));class Tr{constructor(t,n,r){this.flow=t,this.playerID=r,this.dispatch=[],this.initialTurn=n.turn,this.updateTurnContext(n,void 0),this.maxEndedTurnsPerAction=n.numPlayers*100}api(){const t={_private:this};for(const n of this.flow.eventNames)t[n]=(...r)=>{this.dispatch.push({type:n,args:r,phase:this.currentPhase,turn:this.currentTurn,calledFrom:this.currentMethod,error:new Error("Events Plugin Error")})};return t}isUsed(){return this.dispatch.length>0}updateTurnContext(t,n){this.currentPhase=t.phase,this.currentTurn=t.turn,this.currentMethod=n}unsetCurrentMethod(){this.currentMethod=void 0}update(t){const n=t,r=({stack:i},s)=>({...n,plugins:{...n.plugins,events:{...n.plugins.events,data:{error:s+`
`+i}}}});e:for(let i=0;i<this.dispatch.length;i++){const s=this.dispatch[i],a=s.turn!==t.ctx.turn;if(this.currentTurn-this.initialTurn>=this.maxEndedTurnsPerAction)return r(s.error,ne.MaxTurnEndings);if(s.calledFrom===void 0)return r(s.error,ne.CalledOutsideHook);if(t.ctx.gameover)break e;switch(s.type){case"endStage":case"setStage":case"setActivePlayers":{switch(s.calledFrom){case L.TURN_ON_END:case L.PHASE_ON_END:return r(s.error,ne.StageEventInOnEnd);case L.PHASE_ON_BEGIN:return r(s.error,ne.StageEventInPhaseBegin);case L.TURN_ON_BEGIN:if(s.type==="setActivePlayers")break;return r(s.error,ne.StageEventInTurnBegin)}if(a)continue e;break}case"endTurn":{if(s.calledFrom===L.TURN_ON_END||s.calledFrom===L.PHASE_ON_END)return r(s.error,ne.EndTurnInOnEnd);if(a)continue e;break}case"endPhase":case"setPhase":{if(s.calledFrom===L.PHASE_ON_END)return r(s.error,ne.PhaseEventInOnEnd);if(s.phase!==t.ctx.phase)continue e;break}}const c=dn(s.type,s.args,this.playerID);t=this.flow.processEvent(t,c)}return t}}const Pt={name:"events",noClient:({api:e})=>e._private.isUsed(),isInvalid:({data:e})=>e.error||!1,fnWrap:(e,t)=>(n,...r)=>{const i=n.events;i&&i._private.updateTurnContext(n.ctx,t);const s=e(n,...r);return i&&i._private.unsetCurrentMethod(),s},dangerouslyFlushRawState:({state:e,api:t})=>t._private.update(e),api:({game:e,ctx:t,playerID:n})=>new Tr(e.flow,t,n).api()},Rr={name:"log",flush:()=>({}),api:({data:e})=>({setMetadata:t=>{e.metadata=t}}),setup:()=>({})},xr={name:"plugin-serializable",fnWrap:e=>(t,...n)=>e(t,...n)},Cr=(...e)=>console.error(...e);function ls(e){}function x(e){Cr("ERROR:",e)}const _t=[Nr,Mr,Rr,xr],we=[..._t,Pt],Gr=(e,t,n)=>(n.game.plugins.filter(r=>r.action!==void 0).filter(r=>r.name===t.payload.type).forEach(r=>{const i=r.name,s=e.plugins[i]||{data:{}},a=r.action(s.data,t.payload);e={...e,plugins:{...e.plugins,[i]:{...s,data:a}}}}),e),me=({plugins:e})=>Object.entries(e||{}).reduce((t,[n,{api:r}])=>(t[n]=r,t),{}),bn=(e,t,n)=>[..._t,...n,Pt].filter(r=>r.fnWrap!==void 0).reduce((r,{fnWrap:i})=>i(r,t),e),kr=(e,t)=>([...we,...t.game.plugins].filter(n=>n.setup!==void 0).forEach(n=>{const r=n.name,i=n.setup({G:e.G,ctx:e.ctx,game:t.game});e={...e,plugins:{...e.plugins,[r]:{data:i}}}}),e),At=(e,t)=>([...we,...t.game.plugins].filter(n=>n.api!==void 0).forEach(n=>{const r=n.name,i=e.plugins[r]||{data:{}},s=n.api({G:e.G,ctx:e.ctx,data:i.data,game:t.game,playerID:t.playerID});e={...e,plugins:{...e.plugins,[r]:{...i,api:s}}}}),e),Lr=(e,t)=>([..._t,...t.game.plugins,Pt].reverse().forEach(n=>{const r=n.name,i=e.plugins[r]||{data:{}};if(n.flush){const s=n.flush({G:e.G,ctx:e.ctx,game:t.game,api:i.api,data:i.data});e={...e,plugins:{...e.plugins,[n.name]:{data:s}}}}else if(n.dangerouslyFlushRawState){e=n.dangerouslyFlushRawState({state:e,game:t.game,api:i.api,data:i.data});const s=e.plugins[r].data;e={...e,plugins:{...e.plugins,[n.name]:{data:s}}}}}),e),Fr=(e,t)=>[...we,...t.game.plugins].filter(n=>n.noClient!==void 0).map(n=>{const r=n.name,i=e.plugins[r];return i?n.noClient({G:e.G,ctx:e.ctx,game:t.game,api:i.api,data:i.data}):!1}).includes(!0),jr=(e,t)=>[...we,...t.game.plugins].filter(r=>r.isInvalid!==void 0).map(r=>{const{name:i}=r,s=e.plugins[i],a=r.isInvalid({G:e.G,ctx:e.ctx,game:t.game,data:s&&s.data});return a?{plugin:i,message:a}:!1}).find(r=>r)||!1,En=(e,t)=>{const n=Lr(e,t),r=jr(n,t);if(!r)return[n];const{plugin:i,message:s}=r;return x(`${i} plugin declared action invalid:
${s}`),[e,r]},Ur=({G:e,ctx:t,plugins:n={}},{game:r,playerID:i})=>([...we,...r.plugins].forEach(({name:s,playerView:a})=>{if(!a)return;const{data:o}=n[s]||{data:{}},c=a({G:e,ctx:t,game:r,data:o,playerID:i});n={...n,[s]:{data:c}}}),n);function Be(e,t=!1){e.moveLimit&&(t&&(e.minMoves=e.moveLimit),e.maxMoves=e.moveLimit,delete e.moveLimit)}function He(e,t){let n={},r=[],i=null,s={},a={};if(Array.isArray(t)){const c={};t.forEach(f=>c[f]=$e.NULL),n=c}else{if(Be(t),t.next&&(i=t.next),t.revert&&(r=[...e._prevActivePlayers,{activePlayers:e.activePlayers,_activePlayersMinMoves:e._activePlayersMinMoves,_activePlayersMaxMoves:e._activePlayersMaxMoves,_activePlayersNumMoves:e._activePlayersNumMoves}]),t.currentPlayer!==void 0&&We(n,s,a,e.currentPlayer,t.currentPlayer),t.others!==void 0)for(let c=0;c<e.playOrder.length;c++){const f=e.playOrder[c];f!==e.currentPlayer&&We(n,s,a,f,t.others)}if(t.all!==void 0)for(let c=0;c<e.playOrder.length;c++){const f=e.playOrder[c];We(n,s,a,f,t.all)}if(t.value)for(const c in t.value)We(n,s,a,c,t.value[c]);if(t.minMoves)for(const c in n)s[c]===void 0&&(s[c]=t.minMoves);if(t.maxMoves)for(const c in n)a[c]===void 0&&(a[c]=t.maxMoves)}Object.keys(n).length===0&&(n=null),Object.keys(s).length===0&&(s=null),Object.keys(a).length===0&&(a=null);const o={};for(const c in n)o[c]=0;return{...e,activePlayers:n,_activePlayersMinMoves:s,_activePlayersMaxMoves:a,_activePlayersNumMoves:o,_prevActivePlayers:r,_nextActivePlayers:i}}function Kr(e){let{activePlayers:t,_activePlayersMinMoves:n,_activePlayersMaxMoves:r,_activePlayersNumMoves:i,_prevActivePlayers:s,_nextActivePlayers:a}=e;if(t&&Object.keys(t).length===0)if(a)e=He(e,a),{activePlayers:t,_activePlayersMinMoves:n,_activePlayersMaxMoves:r,_activePlayersNumMoves:i,_prevActivePlayers:s}=e;else if(s.length>0){const o=s.length-1;({activePlayers:t,_activePlayersMinMoves:n,_activePlayersMaxMoves:r,_activePlayersNumMoves:i}=s[o]),s=s.slice(0,o)}else t=null,n=null,r=null;return{...e,activePlayers:t,_activePlayersMinMoves:n,_activePlayersMaxMoves:r,_activePlayersNumMoves:i,_prevActivePlayers:s}}function We(e,t,n,r,i){(typeof i!="object"||i===$e.NULL)&&(i={stage:i}),i.stage!==void 0&&(Be(i),e[r]=i.stage,i.minMoves&&(t[r]=i.minMoves),i.maxMoves&&(n[r]=i.maxMoves))}function St(e,t){return e[t]+""}function Br(e,t){let{G:n,ctx:r}=e;const{numPlayers:i}=r,a={...me(e),G:n,ctx:r},o=t.order;let c=[...Array.from({length:i})].map((p,b)=>b+"");o.playOrder!==void 0&&(c=o.playOrder(a));const f=o.first(a),d=typeof f;d!=="number"&&x(`invalid value returned by turn.order.first — expected number got ${d} “${f}”.`);const g=St(c,f);return r={...r,currentPlayer:g,playOrderPos:f,playOrder:c},r=He(r,t.activePlayers||{}),r}function Hr(e,t,n,r){const i=n.order;let{G:s,ctx:a}=e,o=a.playOrderPos,c=!1;if(r&&r!==!0)typeof r!="object"&&x(`invalid argument to endTurn: ${r}`),Object.keys(r).forEach(f=>{switch(f){case"remove":t=St(a.playOrder,o);break;case"next":o=a.playOrder.indexOf(r.next),t=r.next;break;default:x(`invalid argument to endTurn: ${f}`)}});else{const d={...me(e),G:s,ctx:a},g=i.next(d),p=typeof g;g!==void 0&&p!=="number"&&x(`invalid value returned by turn.order.next — expected number or undefined got ${p} “${g}”.`),g===void 0?c=!0:(o=g,t=St(a.playOrder,o))}return a={...a,playOrderPos:o,currentPlayer:t},{endPhase:c,ctx:a}}const Mt={DEFAULT:{first:({ctx:e})=>e.turn===0?e.playOrderPos:(e.playOrderPos+1)%e.playOrder.length,next:({ctx:e})=>(e.playOrderPos+1)%e.playOrder.length},RESET:{first:()=>0,next:({ctx:e})=>(e.playOrderPos+1)%e.playOrder.length},CONTINUE:{first:({ctx:e})=>e.playOrderPos,next:({ctx:e})=>(e.playOrderPos+1)%e.playOrder.length},ONCE:{first:()=>0,next:({ctx:e})=>{if(e.playOrderPos<e.playOrder.length-1)return e.playOrderPos+1}},CUSTOM:e=>({playOrder:()=>e,first:()=>0,next:({ctx:t})=>(t.playOrderPos+1)%t.playOrder.length}),CUSTOM_FROM:e=>({playOrder:({G:t})=>t[e],first:()=>0,next:({ctx:t})=>(t.playOrderPos+1)%t.playOrder.length})},$e={NULL:null};var It={},re={},On;function Pn(){if(On)return re;On=1,Object.defineProperty(re,"__esModule",{value:!0}),re.Pointer=re.escapeToken=re.unescapeToken=void 0;function e(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}re.unescapeToken=e;function t(r){return r.replace(/~/g,"~0").replace(/\//g,"~1")}re.escapeToken=t;var n=function(){function r(i){i===void 0&&(i=[""]),this.tokens=i}return r.fromJSON=function(i){var s=i.split("/").map(e);if(s[0]!=="")throw new Error("Invalid JSON Pointer: ".concat(i));return new r(s)},r.prototype.toString=function(){return this.tokens.map(t).join("/")},r.prototype.evaluate=function(i){for(var s=null,a="",o=i,c=1,f=this.tokens.length;c<f;c++)s=o,a=this.tokens[c],!(a=="__proto__"||a=="constructor"||a=="prototype")&&(o=(s||{})[a]);return{parent:s,key:a,value:o}},r.prototype.get=function(i){return this.evaluate(i).value},r.prototype.set=function(i,s){var a=this.evaluate(i);a.parent&&(a.parent[a.key]=s)},r.prototype.push=function(i){this.tokens.push(i)},r.prototype.add=function(i){var s=this.tokens.concat(String(i));return new r(s)},r}();return re.Pointer=n,re}var N={},wt={},_n;function An(){return _n||(_n=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.clone=e.objectType=e.hasOwnProperty=void 0,e.hasOwnProperty=Object.prototype.hasOwnProperty;function t(i){return i===void 0?"undefined":i===null?"null":Array.isArray(i)?"array":typeof i}e.objectType=t;function n(i){return i!=null&&typeof i=="object"}function r(i){if(!n(i))return i;if(i.constructor==Array){for(var s=i.length,a=new Array(s),o=0;o<s;o++)a[o]=r(i[o]);return a}if(i.constructor==Date){var c=new Date(+i);return c}var f={};for(var d in i)e.hasOwnProperty.call(i,d)&&(f[d]=r(i[d]));return f}e.clone=r}(wt)),wt}var K={},Sn;function Mn(){if(Sn)return K;Sn=1,Object.defineProperty(K,"__esModule",{value:!0}),K.diffAny=K.diffObjects=K.diffArrays=K.intersection=K.subtract=K.isDestructive=void 0;var e=An();function t(d){var g=d.op;return g==="remove"||g==="replace"||g==="copy"||g==="move"}K.isDestructive=t;function n(d,g){var p={};for(var b in d)e.hasOwnProperty.call(d,b)&&d[b]!==void 0&&(p[b]=1);for(var P in g)e.hasOwnProperty.call(g,P)&&g[P]!==void 0&&delete p[P];return Object.keys(p)}K.subtract=n;function r(d){for(var g=d.length,p={},b=0;b<g;b++){var P=d[b];for(var O in P)e.hasOwnProperty.call(P,O)&&P[O]!==void 0&&(p[O]=(p[O]||0)+1)}for(var O in p)p[O]<g&&delete p[O];return Object.keys(p)}K.intersection=r;function i(d){return d.op==="add"}function s(d){return d.op==="remove"}function a(d,g){return{operations:d.operations.concat(g),cost:d.cost+1}}function o(d,g,p,b){b===void 0&&(b=f);var P={"0,0":{operations:[],cost:0}};function O(A,w){var ee="".concat(A,",").concat(w),j=P[ee];if(j===void 0){if(A>0&&w>0&&!b(d[A-1],g[w-1],p.add(String(A-1))).length)j=O(A-1,w-1);else{var se=[];if(A>0){var Ce=O(A-1,w),fe={op:"remove",index:A-1};se.push(a(Ce,fe))}if(w>0){var he=O(A,w-1),Z={op:"add",index:A-1,value:g[w-1]};se.push(a(he,Z))}if(A>0&&w>0){var _e=O(A-1,w-1),Ge={op:"replace",index:A-1,original:d[A-1],value:g[w-1]};se.push(a(_e,Ge))}var qe=se.sort(function(Wt,$t){return Wt.cost-$t.cost})[0];j=qe}P[ee]=j}return j}var E=isNaN(d.length)||d.length<=0?0:d.length,y=isNaN(g.length)||g.length<=0?0:g.length,h=O(E,y).operations,_=h.reduce(function(A,w){var ee=A[0],j=A[1];if(i(w)){var se=w.index+1+j,Ce=se<E+j?String(se):"-",fe={op:w.op,path:p.add(Ce).toString(),value:w.value};return[ee.concat(fe),j+1]}else if(s(w)){var fe={op:w.op,path:p.add(String(w.index+j)).toString()};return[ee.concat(fe),j-1]}else{var he=p.add(String(w.index+j)),Z=b(w.original,w.value,he);return[ee.concat.apply(ee,Z),j]}},[[],0])[0];return _}K.diffArrays=o;function c(d,g,p,b){b===void 0&&(b=f);var P=[];return n(d,g).forEach(function(O){P.push({op:"remove",path:p.add(O).toString()})}),n(g,d).forEach(function(O){P.push({op:"add",path:p.add(O).toString(),value:g[O]})}),r([d,g]).forEach(function(O){P.push.apply(P,b(d[O],g[O],p.add(O)))}),P}K.diffObjects=c;function f(d,g,p,b){if(b===void 0&&(b=f),d===g)return[];var P=(0,e.objectType)(d),O=(0,e.objectType)(g);return P=="array"&&O=="array"?o(d,g,p,b):P=="object"&&O=="object"?c(d,g,p,b):[{op:"replace",path:p.toString(),value:g}]}return K.diffAny=f,K}var In;function Wr(){if(In)return N;In=1;var e=N&&N.__extends||function(){var E=function(y,h){return E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(_,A){_.__proto__=A}||function(_,A){for(var w in A)Object.prototype.hasOwnProperty.call(A,w)&&(_[w]=A[w])},E(y,h)};return function(y,h){if(typeof h!="function"&&h!==null)throw new TypeError("Class extends value "+String(h)+" is not a constructor or null");E(y,h);function _(){this.constructor=y}y.prototype=h===null?Object.create(h):(_.prototype=h.prototype,new _)}}();Object.defineProperty(N,"__esModule",{value:!0}),N.apply=N.InvalidOperationError=N.test=N.copy=N.move=N.replace=N.remove=N.add=N.TestError=N.MissingError=void 0;var t=Pn(),n=An(),r=Mn(),i=function(E){e(y,E);function y(h){var _=E.call(this,"Value required at path: ".concat(h))||this;return _.path=h,_.name="MissingError",_}return y}(Error);N.MissingError=i;var s=function(E){e(y,E);function y(h,_){var A=E.call(this,"Test failed: ".concat(h," != ").concat(_))||this;return A.actual=h,A.expected=_,A.name="TestError",A}return y}(Error);N.TestError=s;function a(E,y,h){if(Array.isArray(E))if(y=="-")E.push(h);else{var _=parseInt(y,10);E.splice(_,0,h)}else E[y]=h}function o(E,y){if(Array.isArray(E)){var h=parseInt(y,10);E.splice(h,1)}else delete E[y]}function c(E,y){var h=t.Pointer.fromJSON(y.path).evaluate(E);return h.parent===void 0?new i(y.path):(a(h.parent,h.key,(0,n.clone)(y.value)),null)}N.add=c;function f(E,y){var h=t.Pointer.fromJSON(y.path).evaluate(E);return h.value===void 0?new i(y.path):(o(h.parent,h.key),null)}N.remove=f;function d(E,y){var h=t.Pointer.fromJSON(y.path).evaluate(E);if(h.parent===null)return new i(y.path);if(Array.isArray(h.parent)){if(parseInt(h.key,10)>=h.parent.length)return new i(y.path)}else if(h.value===void 0)return new i(y.path);return h.parent[h.key]=(0,n.clone)(y.value),null}N.replace=d;function g(E,y){var h=t.Pointer.fromJSON(y.from).evaluate(E);if(h.value===void 0)return new i(y.from);var _=t.Pointer.fromJSON(y.path).evaluate(E);return _.parent===void 0?new i(y.path):(o(h.parent,h.key),a(_.parent,_.key,h.value),null)}N.move=g;function p(E,y){var h=t.Pointer.fromJSON(y.from).evaluate(E);if(h.value===void 0)return new i(y.from);var _=t.Pointer.fromJSON(y.path).evaluate(E);return _.parent===void 0?new i(y.path):(a(_.parent,_.key,(0,n.clone)(h.value)),null)}N.copy=p;function b(E,y){var h=t.Pointer.fromJSON(y.path).evaluate(E);return(0,r.diffAny)(h.value,y.value,new t.Pointer).length?new s(h.value,y.value):null}N.test=b;var P=function(E){e(y,E);function y(h){var _=E.call(this,"Invalid operation: ".concat(h.op))||this;return _.operation=h,_.name="InvalidOperationError",_}return y}(Error);N.InvalidOperationError=P;function O(E,y){switch(y.op){case"add":return c(E,y);case"remove":return f(E,y);case"replace":return d(E,y);case"move":return g(E,y);case"copy":return p(E,y);case"test":return b(E,y)}return new P(y)}return N.apply=O,N}var wn;function $r(){return wn||(wn=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.createTests=e.createPatch=e.applyPatch=e.Pointer=void 0;var t=Pn();Object.defineProperty(e,"Pointer",{enumerable:!0,get:function(){return t.Pointer}});var n=Wr(),r=Mn();function i(f,d){return d.map(function(g){return(0,n.apply)(f,g)})}e.applyPatch=i;function s(f){function d(g,p,b){var P=f(g,p,b);return Array.isArray(P)?P:(0,r.diffAny)(g,p,b,d)}return d}function a(f,d,g){var p=new t.Pointer;return(g?s(g):r.diffAny)(f,d,p)}e.createPatch=a;function o(f,d){var g=t.Pointer.fromJSON(d).evaluate(f);if(g!==void 0)return{op:"test",path:d,value:g.value}}function c(f,d){var g=new Array;return d.filter(r.isDestructive).forEach(function(p){var b=o(f,p.path);if(b&&g.push(b),"from"in p){var P=o(f,p.from);P&&g.push(P)}}),g}e.createTests=c}(It)),It}var Vr=$r();function Jr({moves:e,phases:t,endIf:n,onEnd:r,turn:i,events:s,plugins:a}){e===void 0&&(e={}),s===void 0&&(s={}),a===void 0&&(a=[]),t===void 0&&(t={}),n||(n=()=>{}),r||(r=({G:u})=>u),i||(i={});const o={...t};""in o&&x("cannot specify phase with empty name"),o[""]={};const c={},f=new Set;let d=null;Object.keys(e).forEach(u=>f.add(u));const g=(u,l)=>{const v=bn(u,l,a);return I=>{const M=me(I);return v({...M,G:I.G,ctx:I.ctx,playerID:I.playerID})}},p=u=>l=>{const v=me(l);return u({...v,G:l.G,ctx:l.ctx})},b={onEnd:g(r,L.GAME_ON_END),endIf:p(n)};for(const u in o){const l=o[u];if(l.start===!0&&(d=u),l.moves!==void 0)for(const v of Object.keys(l.moves))c[u+"."+v]=l.moves[v],f.add(v);l.endIf===void 0&&(l.endIf=()=>{}),l.onBegin===void 0&&(l.onBegin=({G:v})=>v),l.onEnd===void 0&&(l.onEnd=({G:v})=>v),l.turn===void 0&&(l.turn=i),l.turn.order===void 0&&(l.turn.order=Mt.DEFAULT),l.turn.onBegin===void 0&&(l.turn.onBegin=({G:v})=>v),l.turn.onEnd===void 0&&(l.turn.onEnd=({G:v})=>v),l.turn.endIf===void 0&&(l.turn.endIf=()=>!1),l.turn.onMove===void 0&&(l.turn.onMove=({G:v})=>v),l.turn.stages===void 0&&(l.turn.stages={}),Be(l.turn,!0);for(const v in l.turn.stages){const M=l.turn.stages[v].moves||{};for(const S of Object.keys(M)){const C=u+"."+v+"."+S;c[C]=M[S],f.add(S)}}if(l.wrapped={onBegin:g(l.onBegin,L.PHASE_ON_BEGIN),onEnd:g(l.onEnd,L.PHASE_ON_END),endIf:p(l.endIf)},l.turn.wrapped={onMove:g(l.turn.onMove,L.TURN_ON_MOVE),onBegin:g(l.turn.onBegin,L.TURN_ON_BEGIN),onEnd:g(l.turn.onEnd,L.TURN_ON_END),endIf:p(l.turn.endIf)},typeof l.next!="function"){const{next:v}=l;l.next=()=>v||null}l.wrapped.next=p(l.next)}function P(u){return u.phase?o[u.phase]:o[""]}function O(u){return u}function E(u,l){const v=new Set,I=new Set;for(let M=0;M<l.length;M++){const{fn:S,arg:C,...T}=l[M];if(S===Z){I.clear();const H=u.ctx.phase;if(v.has(H)){const te={...u.ctx,phase:null};return{...u,ctx:te}}v.add(H)}const q=[];if(u=S(u,{...T,arg:C,next:q}),S===he)break;const G=se(u);if(G){l.push({fn:he,arg:G,turn:u.ctx.turn,phase:u.ctx.phase,automatic:!0});continue}const k=Ce(u);if(k){l.push({fn:Z,arg:k,turn:u.ctx.turn,phase:u.ctx.phase,automatic:!0});continue}if([O,ee,j].includes(S)){const H=fe(u);if(H){l.push({fn:_e,arg:H,turn:u.ctx.turn,phase:u.ctx.phase,automatic:!0});continue}}l.push(...q)}return u}function y(u,{next:l}){return l.push({fn:h}),u}function h(u,{next:l}){let{G:v,ctx:I}=u;return v=P(I).wrapped.onBegin(u),l.push({fn:_}),{...u,G:v,ctx:I}}function _(u,{currentPlayer:l}){let{ctx:v}=u;const I=P(v);l?(v={...v,currentPlayer:l},I.turn.activePlayers&&(v=He(v,I.turn.activePlayers))):v=Br(u,I.turn);const M=v.turn+1;v={...v,turn:M,numMoves:0,_prevActivePlayers:[]};const S=I.turn.wrapped.onBegin({...u,ctx:v});return{...u,G:S,ctx:v,_undo:[],_redo:[]}}function A(u,{arg:l,next:v,phase:I}){const M=P({phase:I});let{ctx:S}=u;if(l&&l.next)if(l.next in o)S={...S,phase:l.next};else return x("invalid phase: "+l.next),u;else S={...S,phase:M.wrapped.next(u)||null};return u={...u,ctx:S},v.push({fn:h}),u}function w(u,{arg:l,currentPlayer:v,next:I}){let{G:M,ctx:S}=u;const C=P(S),{endPhase:T,ctx:q}=Hr(u,v,C.turn,l);return S=q,u={...u,G:M,ctx:S},T?I.push({fn:Z,turn:S.turn,phase:S.phase}):I.push({fn:_,currentPlayer:S.currentPlayer}),u}function ee(u,{arg:l,playerID:v}){if((typeof l=="string"||l===$e.NULL)&&(l={stage:l}),typeof l!="object")return u;Be(l);let{ctx:I}=u,{activePlayers:M,_activePlayersMinMoves:S,_activePlayersMaxMoves:C,_activePlayersNumMoves:T}=I;return l.stage!==void 0&&(M===null&&(M={}),M[v]=l.stage,T[v]=0,l.minMoves&&(S===null&&(S={}),S[v]=l.minMoves),l.maxMoves&&(C===null&&(C={}),C[v]=l.maxMoves)),I={...I,activePlayers:M,_activePlayersMinMoves:S,_activePlayersMaxMoves:C,_activePlayersNumMoves:T},{...u,ctx:I}}function j(u,{arg:l}){return{...u,ctx:He(u.ctx,l)}}function se(u){return b.endIf(u)}function Ce(u){return P(u.ctx).wrapped.endIf(u)}function fe(u){const l=P(u.ctx),v=u.ctx.numMoves||0;return l.turn.maxMoves&&v>=l.turn.maxMoves?!0:l.turn.wrapped.endIf(u)}function he(u,{arg:l,phase:v}){u=Z(u,{}),l===void 0&&(l=!0),u={...u,ctx:{...u.ctx,gameover:l}};const I=b.onEnd(u);return{...u,G:I}}function Z(u,{arg:l,next:v,turn:I,automatic:M}){u=_e(u,{turn:I,force:!0,automatic:!0});const{phase:S,turn:C}=u.ctx;if(v&&v.push({fn:A,arg:l,phase:S}),S===null)return u;const q=P(u.ctx).wrapped.onEnd(u),G={...u.ctx,phase:null},k=Ie("endPhase",l),{_stateID:H}=u,te={action:k,_stateID:H,turn:C,phase:S};M&&(te.automatic=!0);const pe=[...u.deltalog||[],te];return{...u,G:q,ctx:G,deltalog:pe}}function _e(u,{arg:l,next:v,turn:I,force:M,automatic:S,playerID:C}){if(I!==u.ctx.turn)return u;const{currentPlayer:T,numMoves:q,phase:G,turn:k}=u.ctx,H=P(u.ctx),te=q||0;if(!M&&H.turn.minMoves&&te<H.turn.minMoves)return`${H.turn.minMoves}`,u;const pe=H.turn.wrapped.onEnd(u);v&&v.push({fn:w,arg:l,currentPlayer:T});let ue={...u.ctx,activePlayers:null};if(l&&l.remove){C=C||T;const ve=ue.playOrder.filter(os=>os!=C),as=ue.playOrderPos>ve.length-1?0:ue.playOrderPos;if(ue={...ue,playOrder:ve,playOrderPos:as},ve.length===0)return v.push({fn:Z,turn:k,phase:G}),u}const Vt=Ie("endTurn",l),{_stateID:lr}=u,ke={action:Vt,_stateID:lr,turn:k,phase:G};S&&(ke.automatic=!0);const Jt=[...u.deltalog||[],ke];return{...u,G:pe,ctx:ue,deltalog:Jt,_undo:[],_redo:[]}}function Ge(u,{arg:l,next:v,automatic:I,playerID:M}){M=M||u.ctx.currentPlayer;let{ctx:S,_stateID:C}=u,{activePlayers:T,_activePlayersNumMoves:q,_activePlayersMinMoves:G,_activePlayersMaxMoves:k,phase:H,turn:te}=S;const pe=T!==null&&M in T,ue=P(S);if(!l&&pe){const ve=ue.turn.stages[T[M]];ve&&ve.next&&(l=ve.next)}if(v&&v.push({fn:ee,arg:l,playerID:M}),!pe)return u;const Vt=q[M]||0;if(G&&G[M]&&Vt<G[M])return`${G[M]}`,u;T={...T},delete T[M],G&&(G={...G},delete G[M]),k&&(k={...k},delete k[M]),S=Kr({...S,activePlayers:T,_activePlayersMinMoves:G,_activePlayersMaxMoves:k});const ke={action:Ie("endStage",l),_stateID:C,turn:te,phase:H};I&&(ke.automatic=!0);const Jt=[...u.deltalog||[],ke];return{...u,ctx:S,deltalog:Jt}}function qe(u,l,v){const I=P(u),M=I.turn.stages,{activePlayers:S}=u;if(S&&S[v]!==void 0&&S[v]!==$e.NULL&&M[S[v]]!==void 0&&M[S[v]].moves!==void 0){const T=M[S[v]].moves;if(l in T)return T[l]}else if(I.moves){if(l in I.moves)return I.moves[l]}else if(l in e)return e[l];return null}function Wt(u,l){const{playerID:v,type:I}=l,{currentPlayer:M,activePlayers:S,_activePlayersMaxMoves:C}=u.ctx,T=qe(u.ctx,I,v),q=!T||typeof T=="function"||T.noLimit!==!0;let{numMoves:G,_activePlayersNumMoves:k}=u.ctx;q&&(v===M&&G++,S&&k[v]++),u={...u,ctx:{...u.ctx,numMoves:G,_activePlayersNumMoves:k}},C&&k[v]>=C[v]&&(u=Ge(u,{playerID:v,automatic:!0}));const te=P(u.ctx).turn.wrapped.onMove({...u,playerID:v});return u={...u,G:te},E(u,[{fn:O}])}function $t(u,l,v){return E(u,[{fn:Ge,arg:v,playerID:l}])}function Xi(u,l){return E(u,[{fn:Ge,playerID:l}])}function Zi(u,l,v){return E(u,[{fn:j,arg:v}])}function Qi(u,l,v){return E(u,[{fn:Z,phase:u.ctx.phase,turn:u.ctx.turn,arg:{next:v}}])}function es(u){return E(u,[{fn:Z,phase:u.ctx.phase,turn:u.ctx.turn}])}function ts(u,l,v){return E(u,[{fn:_e,turn:u.ctx.turn,phase:u.ctx.phase,arg:v}])}function ns(u,l,v){return E(u,[{fn:_e,turn:u.ctx.turn,phase:u.ctx.phase,force:!0,arg:v}])}function rs(u,l,v){return E(u,[{fn:he,turn:u.ctx.turn,phase:u.ctx.phase,arg:v}])}const ze={endStage:Xi,setStage:$t,endTurn:ts,pass:ns,endPhase:es,setPhase:Qi,endGame:rs,setActivePlayers:Zi},ae=[];s.endTurn!==!1&&ae.push("endTurn"),s.pass!==!1&&ae.push("pass"),s.endPhase!==!1&&ae.push("endPhase"),s.setPhase!==!1&&ae.push("setPhase"),s.endGame!==!1&&ae.push("endGame"),s.setActivePlayers!==!1&&ae.push("setActivePlayers"),s.endStage!==!1&&ae.push("endStage"),s.setStage!==!1&&ae.push("setStage");function is(u,l){const{type:v,playerID:I,args:M}=l.payload;return typeof ze[v]!="function"?u:ze[v](u,I,...Array.isArray(M)?M:[M])}function ss(u,l,v){return l.activePlayers?v in l.activePlayers:l.currentPlayer===v}return{ctx:u=>({numPlayers:u,turn:0,currentPlayer:"0",playOrder:[...Array.from({length:u})].map((l,v)=>v+""),playOrderPos:0,phase:d,activePlayers:null}),init:u=>E(u,[{fn:y}]),isPlayerActive:ss,eventHandlers:ze,eventNames:Object.keys(ze),enabledEventNames:ae,moveMap:c,moveNames:[...f.values()],processMove:Wt,processEvent:is,getMove:qe}}function Yr(e){return e.processMove!==void 0}function Dt(e){if(Yr(e))return e;if(e.name===void 0&&(e.name="default"),e.deltaState===void 0&&(e.deltaState=!1),e.disableUndo===void 0&&(e.disableUndo=!1),e.setup===void 0&&(e.setup=()=>({})),e.moves===void 0&&(e.moves={}),e.playerView===void 0&&(e.playerView=({G:n})=>n),e.plugins===void 0&&(e.plugins=[]),e.plugins.forEach(n=>{if(n.name===void 0)throw new Error("Plugin missing name attribute");if(n.name.includes(" "))throw new Error(n.name+": Plugin name must not include spaces")}),e.name.includes(" "))throw new Error(e.name+": Game name must not include spaces");const t=Jr(e);return{...e,flow:t,moveNames:t.moveNames,pluginNames:e.plugins.map(n=>n.name),processMove:(n,r)=>{let i=t.getMove(n.ctx,r.type,r.playerID);if(qr(i)&&(i=i.move),i instanceof Function){const s=bn(i,L.MOVE,e.plugins);let a=[];r.args!==void 0&&(a=Array.isArray(r.args)?r.args:[r.args]);const o={...me(n),G:n.G,ctx:n.ctx,playerID:r.playerID};return s(o,...a)}return x(`invalid move object: ${r.type}`),n.G}}}function qr(e){return e instanceof Object&&e.move!==void 0}var Nt;(function(e){e.UnauthorizedAction="update/unauthorized_action",e.MatchNotFound="update/match_not_found",e.PatchFailed="update/patch_failed"})(Nt||(Nt={}));var F;(function(e){e.StaleStateId="action/stale_state_id",e.UnavailableMove="action/unavailable_move",e.InvalidMove="action/invalid_move",e.InactivePlayer="action/inactive_player",e.GameOver="action/gameover",e.ActionDisabled="action/action_disabled",e.ActionInvalid="action/action_invalid",e.PluginActionInvalid="action/plugin_invalid"})(F||(F={}));const Ve=e=>e.payload.playerID!==null&&e.payload.playerID!==void 0,zr=(e,t,n)=>{function r(s){return s.undoable!==void 0}function i(s){return s instanceof Function}return r(n)?i(n.undoable)?n.undoable({G:e,ctx:t}):n.undoable:!0};function Dn(e,t){if(t.game.disableUndo)return e;const n={G:e.G,ctx:e.ctx,plugins:e.plugins,playerID:t.action.payload.playerID||e.ctx.currentPlayer};return t.action.type==="MAKE_MOVE"&&(n.moveType=t.action.payload.type),{...e,_undo:[...e._undo,n],_redo:[]}}function Tt(e,t,n){const r={action:t,_stateID:e._stateID,turn:e.ctx.turn,phase:e.ctx.phase},i=e.plugins.log.data.metadata;return i!==void 0&&(r.metadata=i),typeof n=="object"&&n.redact===!0?r.redact=!0:typeof n=="object"&&n.redact instanceof Function&&(r.redact=n.redact({G:e.G,ctx:e.ctx})),{...e,deltalog:[r]}}function Rt(e,t,n){const[r,i]=En(e,n);return i?[r,B(t,F.PluginActionInvalid,i)]:[r]}function Nn(e){if(!e)return[null,void 0];const{transients:t,...n}=e;return[n,t]}function B(e,t,n){return{...e,transients:{error:{type:t,payload:n}}}}const Xr=e=>t=>n=>{const r=t(n);switch(n.type){case Ke:return r;default:{const[,i]=Nn(e.getState());return typeof i<"u"?(e.dispatch(mn()),{...r,transients:i}):r}}};function Tn({game:e,isClient:t}){return e=Dt(e),(n=null,r)=>{let[i]=Nn(n);switch(r.type){case Ke:return i;case Ue:{if(i={...i,deltalog:[]},t)return i;if(i.ctx.gameover!==void 0)return x("cannot call event after game end"),B(i,F.GameOver);if(Ve(r)&&!e.flow.isPlayerActive(i.G,i.ctx,r.payload.playerID))return x(`disallowed event: ${r.payload.type}`),B(i,F.InactivePlayer);i=At(i,{game:e,playerID:r.payload.playerID});let s=e.flow.processEvent(i,r),a;return[s,a]=Rt(s,i,{game:e}),a||(s=Dn(s,{game:e,action:r}),{...s,_stateID:i._stateID+1})}case pt:{const s=i={...i,deltalog:[]},a=e.flow.getMove(i.ctx,r.payload.type,r.payload.playerID||i.ctx.currentPlayer);if(a===null)return x(`disallowed move: ${r.payload.type}`),B(i,F.UnavailableMove);if(t&&a.client===!1)return i;if(i.ctx.gameover!==void 0)return x("cannot make move after game end"),B(i,F.GameOver);if(Ve(r)&&!e.flow.isPlayerActive(i.G,i.ctx,r.payload.playerID))return x(`disallowed move: ${r.payload.type}`),B(i,F.InactivePlayer);i=At(i,{game:e,playerID:r.payload.playerID});const o=e.processMove(i,r.payload);if(o===Ot)return x(`invalid move: ${r.payload.type} args: ${r.payload.args}`),B(i,F.InvalidMove);const c={...i,G:o};if(t&&Fr(c,{game:e}))return i;if(i=c,t){let d;return[i,d]=Rt(i,s,{game:e}),d||{...i,_stateID:i._stateID+1}}i=Tt(i,r,a),i=e.flow.processMove(i,r.payload);let f;return[i,f]=Rt(i,s,{game:e}),f||(i=Dn(i,{game:e,action:r}),{...i,_stateID:i._stateID+1})}case gt:case bt:case yt:return r.state;case mt:{if(i={...i,deltalog:[]},e.disableUndo)return x("Undo is not enabled"),B(i,F.ActionDisabled);const{G:s,ctx:a,_undo:o,_redo:c,_stateID:f}=i;if(o.length<2)return x("No moves to undo"),B(i,F.ActionInvalid);const d=o[o.length-1],g=o[o.length-2];if(Ve(r)&&r.payload.playerID!==d.playerID)return x("Cannot undo other players' moves"),B(i,F.ActionInvalid);if(d.moveType){const p=e.flow.getMove(g.ctx,d.moveType,d.playerID);if(!zr(s,a,p))return x("Move cannot be undone"),B(i,F.ActionInvalid)}return i=Tt(i,r),{...i,G:g.G,ctx:g.ctx,plugins:g.plugins,_stateID:f+1,_undo:o.slice(0,-1),_redo:[d,...c]}}case vt:{if(i={...i,deltalog:[]},e.disableUndo)return x("Redo is not enabled"),B(i,F.ActionDisabled);const{_undo:s,_redo:a,_stateID:o}=i;if(a.length===0)return x("No moves to redo"),B(i,F.ActionInvalid);const c=a[0];return Ve(r)&&r.payload.playerID!==c.playerID?(x("Cannot redo other players' moves"),B(i,F.ActionInvalid)):(i=Tt(i,r),{...i,G:c.G,ctx:c.ctx,plugins:c.plugins,_stateID:o+1,_undo:[...s,c],_redo:a.slice(1)})}case cn:return Gr(i,r,{game:e});case Et:{const s=i,a=JSON.parse(JSON.stringify(s)),o=Vr.applyPatch(a,r.patch);return o.some(f=>f!==null)?(x(`Patch ${JSON.stringify(r.patch)} apply failed`),B(s,Nt.PatchFailed,o)):a}default:return i}}}class Zr{constructor({enumerate:t,seed:n}){this.enumerateFn=t,this.seed=n,this.iterationCounter=0,this._opts={}}addOpt({key:t,range:n,initial:r}){this._opts[t]={range:n,value:r}}getOpt(t){return this._opts[t].value}setOpt(t,n){t in this._opts&&(this._opts[t].value=n)}opts(){return this._opts}enumerate(t,n,r){const i=this.enumerateFn(t,n,r);return i?i.map(s=>{if("payload"in s)return s;if("move"in s)return ln(s.move,s.args,r);if("event"in s)return Ie(s.event,s.args,r)}):[]}random(t){let n;if(this.seed!==void 0){const r=this.prngstate?"":this.seed,i=an(r,this.prngstate);n=i(),this.prngstate=i.state()}else n=Math.random();if(t)if(Array.isArray(t)){const r=Math.floor(n*t.length);return t[r]}else return Math.floor(n*t);return n}}const Qr=25;class ei extends Zr{constructor({enumerate:t,seed:n,objectives:r,game:i,iterations:s,playoutDepth:a,iterationCallback:o,isAsync:c=!0,isInstantForSingleAction:f=!0}){super({enumerate:t,seed:n}),this.isStopped=!1,r===void 0&&(r=()=>({})),this.objectives=r,this.iterationCallback=o||(()=>{}),this.reducer=Tn({game:i}),this.iterations=s,this.playoutDepth=a,this.isInstantForSingleAction=f,this.addOpt({key:"async",initial:c??!1}),this.addOpt({key:"iterations",initial:typeof s=="number"?s:1e3,range:{min:1,max:2e3}}),this.addOpt({key:"playoutDepth",initial:typeof a=="number"?a:50,range:{min:1,max:100}})}createNode({state:t,parentAction:n,parent:r,playerID:i}){const{G:s,ctx:a}=t;let o=[],c=[];if(i!==void 0)o=this.enumerate(s,a,i),c=this.objectives(s,a,i);else if(a.activePlayers)for(const f in a.activePlayers)o.push(...this.enumerate(s,a,f)),c.push(this.objectives(s,a,f));else o=this.enumerate(s,a,a.currentPlayer),c=this.objectives(s,a,a.currentPlayer);return{state:t,parent:r,parentAction:n,actions:o,objectives:c,children:[],visits:0,value:0}}select(t){if(t.actions.length>0||t.children.length===0)return t;let n=null,r=0;for(const i of t.children){const s=i.visits+Number.EPSILON,a=i.value/s+Math.sqrt(2*Math.log(t.visits)/s);(n==null||a>r)&&(r=a,n=i)}return this.select(n)}expand(t){const n=t.actions;if(n.length===0||t.state.ctx.gameover!==void 0)return t;const r=this.random(n.length),i=n[r];t.actions.splice(r,1);const s=this.reducer(t.state,i),a=this.createNode({state:s,parentAction:i,parent:t});return t.children.push(a),a}playout({state:t}){let n=this.getOpt("playoutDepth");typeof this.playoutDepth=="function"&&(n=this.playoutDepth(t.G,t.ctx));for(let r=0;r<n&&t.ctx.gameover===void 0;r++){const{G:i,ctx:s}=t;let a=s.currentPlayer;s.activePlayers&&(a=Object.keys(s.activePlayers)[0]);const o=this.enumerate(i,s,a),c=this.objectives(i,s,a),f=Object.keys(c).reduce((p,b)=>{const P=c[b];return P.checker(i,s)?p+P.weight:p},0);if(f>0)return{score:f};if(!o||o.length===0)return;const d=this.random(o.length);t=this.reducer(t,o[d])}return t.ctx.gameover}backpropagate(t,n={}){t.visits++,n.score!==void 0&&(t.value+=n.score),n.draw===!0&&(t.value+=.5),t.parentAction&&n.winner===t.parentAction.payload.playerID&&t.value++,t.parent&&this.backpropagate(t.parent,n)}play(t,n,r,i,s){const a=this.createNode({state:t,playerID:n});let o=this.isInstantForSingleAction&&a.actions.length<=1?1:this.getOpt("iterations");typeof this.iterations=="function"&&(o=this.iterations(t.G,t.ctx)),this.isStopped=!1;let c,f;r!==void 0&&(c=setTimeout(()=>{this.isStopped=!0},r)),i!==void 0&&s!==void 0&&(f=setInterval(()=>{s(g())},i));const d=()=>this.iterationCounter<o&&!this.isStopped,g=()=>{let p=null;for(const E of a.children)(p==null||E.visits>p.visits)&&(p=E);const b=p==null?void 0:p.parentAction,P=p&&p.value>=0&&p.visits>0?p.value/p.visits*100:50;return{action:b,metadata:a,percent:P}};return new Promise(p=>{const b=()=>{for(let O=0;O<Qr&&d();O++){const E=this.select(a),y=this.expand(E),h=this.playout(y);this.backpropagate(y,h),this.iterationCounter++}this.iterationCallback({iterationCounter:this.iterationCounter,numIterations:o,metadata:a})};this.iterationCounter=0;const P=()=>{c!==void 0&&clearTimeout(c),f!==void 0&&clearInterval(f),p(g())};if(this.getOpt("async")){const O=()=>{d()?(b(),setImmediate(O)):P()};O()}else{for(;d();)b();P()}})}}let ti="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",ni=(e=21)=>{let t="",n=e|0;for(;n--;)t+=ti[Math.random()*64|0];return t};function De(e){"@babel/helpers - typeof";return De=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},De(e)}function ri(e,t){if(De(e)!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t);if(De(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function ii(e){var t=ri(e,"string");return De(t)=="symbol"?t:t+""}function si(e,t,n){return(t=ii(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Rn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function xn(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Rn(Object(n),!0).forEach(function(r){si(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Rn(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function V(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var Cn=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),Gn=function(){return Math.random().toString(36).substring(7).split("").join(".")},kn={INIT:"@@redux/INIT"+Gn(),REPLACE:"@@redux/REPLACE"+Gn()};function ai(e){if(typeof e!="object"||e===null)return!1;for(var t=e;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function Ln(e,t,n){var r;if(typeof t=="function"&&typeof n=="function"||typeof n=="function"&&typeof arguments[3]=="function")throw new Error(V(0));if(typeof t=="function"&&typeof n>"u"&&(n=t,t=void 0),typeof n<"u"){if(typeof n!="function")throw new Error(V(1));return n(Ln)(e,t)}if(typeof e!="function")throw new Error(V(2));var i=e,s=t,a=[],o=a,c=!1;function f(){o===a&&(o=a.slice())}function d(){if(c)throw new Error(V(3));return s}function g(O){if(typeof O!="function")throw new Error(V(4));if(c)throw new Error(V(5));var E=!0;return f(),o.push(O),function(){if(E){if(c)throw new Error(V(6));E=!1,f();var h=o.indexOf(O);o.splice(h,1),a=null}}}function p(O){if(!ai(O))throw new Error(V(7));if(typeof O.type>"u")throw new Error(V(8));if(c)throw new Error(V(9));try{c=!0,s=i(s,O)}finally{c=!1}for(var E=a=o,y=0;y<E.length;y++){var h=E[y];h()}return O}function b(O){if(typeof O!="function")throw new Error(V(10));i=O,p({type:kn.REPLACE})}function P(){var O,E=g;return O={subscribe:function(h){if(typeof h!="object"||h===null)throw new Error(V(11));function _(){h.next&&h.next(d())}_();var A=E(_);return{unsubscribe:A}}},O[Cn]=function(){return this},O}return p({type:kn.INIT}),r={dispatch:p,subscribe:g,getState:d,replaceReducer:b},r[Cn]=P,r}function Fn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.length===0?function(r){return r}:t.length===1?t[0]:t.reduce(function(r,i){return function(){return r(i.apply(void 0,arguments))}})}function oi(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(r){return function(){var i=r.apply(void 0,arguments),s=function(){throw new Error(V(15))},a={getState:i.getState,dispatch:function(){return s.apply(void 0,arguments)}},o=t.map(function(c){return c(a)});return s=Fn.apply(void 0,o)(i.dispatch),xn(xn({},i),{},{dispatch:s})}}}function ui({game:e,numPlayers:t,setupData:n}){e=Dt(e),t||(t=2);const r=e.flow.ctx(t);let i={G:{},ctx:r,plugins:{}};i=kr(i,{game:e}),i=At(i,{game:e,playerID:void 0});const s=me(i);i.G=e.setup({...s,ctx:i.ctx},n);let a={...i,_undo:[],_redo:[],_stateID:0};return a=e.flow.init(a),[a]=En(a,{game:e}),e.disableUndo||(a._undo=[{G:a.G,ctx:a.ctx,plugins:a.plugins}]),a}class ci{constructor({transportDataCallback:t,gameName:n,playerID:r,matchID:i,credentials:s,numPlayers:a}){this.connectionStatusCallback=()=>{},this.isConnected=!1,this.transportDataCallback=t,this.gameName=n||"default",this.playerID=r||null,this.matchID=i||"default",this.credentials=s,this.numPlayers=a||2}subscribeToConnectionStatus(t){this.connectionStatusCallback=t}setConnectionStatus(t){this.isConnected=t,this.connectionStatusCallback()}notifyClient(t){this.transportDataCallback(t)}}class li extends ci{connect(){}disconnect(){}sendAction(){}sendChatMessage(){}requestSync(){}updateCredentials(){}updateMatchID(){}updatePlayerID(){}}const di=e=>new li(e);class fi{constructor(){this.debugPanel=null,this.currentClient=null,this.clients=new Map,this.subscribers=new Map}register(t){this.clients.set(t,t),this.mountDebug(t),this.notifySubscribers()}unregister(t){if(this.clients.delete(t),this.currentClient===t){this.unmountDebug();for(const[n]of this.clients){if(this.debugPanel)break;this.mountDebug(n)}}this.notifySubscribers()}subscribe(t){const n=Symbol();return this.subscribers.set(n,t),t(this.getState()),()=>{this.subscribers.delete(n)}}switchPlayerID(t){if(this.currentClient.multiplayer){for(const[n]of this.clients)if(n.playerID===t&&n.debugOpt!==!1&&n.multiplayer===this.currentClient.multiplayer){this.switchToClient(n);return}}this.currentClient.updatePlayerID(t),this.notifySubscribers()}switchToClient(t){t!==this.currentClient&&(this.unmountDebug(),this.mountDebug(t),this.notifySubscribers())}notifySubscribers(){const t=this.getState();this.subscribers.forEach(n=>{n(t)})}getState(){return{client:this.currentClient,debuggableClients:this.getDebuggableClients()}}getDebuggableClients(){return[...this.clients.values()].filter(t=>t.debugOpt!==!1)}mountDebug(t){if(t.debugOpt===!1||this.debugPanel!==null||typeof document>"u")return;let n,r=document.body;t.debugOpt&&t.debugOpt!==!0&&(n=t.debugOpt.impl||n,r=t.debugOpt.target||r),n&&(this.currentClient=t,this.debugPanel=new n({target:r,props:{clientManager:this}}))}unmountDebug(){this.debugPanel.$destroy(),this.debugPanel=null,this.currentClient=null}}const hi=new fi;function xt(e,t,n){return!n&&e==null&&(e=t.getState().ctx.currentPlayer),e}function Ct(e,t,n,r,i,s){const a={};for(const o of t)a[o]=(...c)=>{const f=Dr[e](o,c,xt(r,n,s),i);n.dispatch(f)};return a}const pi=Ct.bind(null,"makeMove"),vi=Ct.bind(null,"gameEvent"),gi=Ct.bind(null,"plugin");class yi{constructor({game:t,debug:n,numPlayers:r,multiplayer:i,matchID:s,playerID:a,credentials:o,enhancer:c}){this.game=Dt(t),this.playerID=a,this.matchID=s||"default",this.credentials=o,this.multiplayer=i,this.debugOpt=n,this.manager=hi,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=Tn({game:this.game,isClient:i!==void 0}),this.initialState=null,i||(this.initialState=ui({game:this.game,numPlayers:r})),this.reset=()=>{this.store.dispatch(vn(this.initialState))},this.undo=()=>{const b=gn(xt(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(b)},this.redo=()=>{const b=yn(xt(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(b)},this.log=[];const p=oi(Xr,()=>b=>P=>{const O=b(P);return this.notifySubscribers(),O},b=>P=>O=>{const E=b.getState(),y=P(O);return!("clientOnly"in O)&&O.type!==Ke&&this.transport.sendAction(E,O),y},b=>P=>O=>{const E=P(O),y=b.getState();switch(O.type){case pt:case Ue:case mt:case vt:{const h=y.deltalog;this.log=[...this.log,...h];break}case gt:{this.log=[];break}case Et:case bt:{let h=-1;this.log.length>0&&(h=this.log[this.log.length-1]._stateID);let _=O.deltalog||[];_=_.filter(A=>A._stateID>h),this.log=[...this.log,..._];break}case yt:{this.initialState=O.initialState,this.log=O.log||[];break}}return E});c=c!==void 0?Fn(p,c):p,this.store=Ln(this.reducer,this.initialState,c),i||(i=di),this.transport=i({transportDataCallback:b=>this.receiveTransportData(b),gameKey:t,game:this.game,matchID:s,playerID:a,credentials:o,gameName:this.game.name,numPlayers:r}),this.createDispatchers(),this.chatMessages=[],this.sendChatMessage=b=>{this.transport.sendChatMessage(this.matchID,{id:ni(7),sender:this.playerID,payload:b})}}receiveMatchData(t){this.matchData=t,this.notifySubscribers()}receiveChatMessage(t){this.chatMessages=[...this.chatMessages,t],this.notifySubscribers()}receiveTransportData(t){const[n]=t.args;if(n===this.matchID)switch(t.type){case"sync":{const[,r]=t.args,i=fn(r);this.receiveMatchData(r.filteredMetadata),this.store.dispatch(i);break}case"update":{const[,r,i]=t.args,s=this.store.getState();if(r._stateID>=s._stateID){const a=pn(r,i);this.store.dispatch(a)}break}case"patch":{const[,r,i,s,a]=t.args,o=this.store.getState()._stateID;if(r!==o)break;const c=hn(r,i,s,a);this.store.dispatch(c),this.store.getState()._stateID===o&&this.transport.requestSync();break}case"matchData":{const[,r]=t.args;this.receiveMatchData(r);break}case"chat":{const[,r]=t.args;this.receiveChatMessage(r);break}}}notifySubscribers(){Object.values(this.subscribers).forEach(t=>t(this.getState()))}overrideGameState(t){this.gameStateOverride=t,this.notifySubscribers()}start(){this.transport.connect(),this._running=!0,this.manager.register(this)}stop(){this.transport.disconnect(),this._running=!1,this.manager.unregister(this)}subscribe(t){const n=Object.keys(this.subscribers).length;return this.subscribers[n]=t,this.transport.subscribeToConnectionStatus(()=>this.notifySubscribers()),(this._running||!this.multiplayer)&&t(this.getState()),()=>{delete this.subscribers[n]}}getInitialState(){return this.initialState}getState(){let t=this.store.getState();if(this.gameStateOverride!==null&&(t=this.gameStateOverride),t===null)return t;let n=!0;const r=this.game.flow.isPlayerActive(t.G,t.ctx,this.playerID);return this.multiplayer&&!r&&(n=!1),!this.multiplayer&&this.playerID!==null&&this.playerID!==void 0&&!r&&(n=!1),t.ctx.gameover!==void 0&&(n=!1),this.multiplayer||(t={...t,G:this.game.playerView({G:t.G,ctx:t.ctx,playerID:this.playerID}),plugins:Ur(t,this)}),{...t,log:this.log,isActive:n,isConnected:this.transport.isConnected}}createDispatchers(){this.moves=pi(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=vi(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=gi(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}updatePlayerID(t){this.playerID=t,this.createDispatchers(),this.transport.updatePlayerID(t),this.notifySubscribers()}updateMatchID(t){this.matchID=t,this.createDispatchers(),this.transport.updateMatchID(t),this.notifySubscribers()}updateCredentials(t){this.credentials=t,this.createDispatchers(),this.transport.updateCredentials(t),this.notifySubscribers()}}function mi(e){return new yi(e)}var jn;(function(e){e.TEST_YG="REACT_APP_TEST_YG",e.GAME="REACT_APP_GAME",e.BUILD_FOR_POKI="REACT_APP_BUILD_FOR_POKI",e.BUILD_WITH_LOGS="REACT_APP_BUILD_WITH_LOGS"})(jn||(jn={}));var Un;(function(e){e.IOS="ios",e.Android="android",e.WinPhone="win-phone",e.Unknown="unknown"})(Un||(Un={}));var Kn;(function(e){e.tablet="Tablet(Yandex)",e.tv="TV",e.mobile="Mobile",e.android="Android",e.Ios="IOS",e.desktop="Desktop"})(Kn||(Kn={}));var Bn;(function(e){e.POKI="POKI",e.NONE="NONE",e.CRAZY_GAMES="CRAZY_GAMES",e.GAME_DISTRIBUTION="GAME_DISTRIBUTION",e.GAME_MONETIZE="GAME_MONETIZE",e.OK="OK",e.SMART_MARKET="SMARTMARKET",e.VK="VK",e.YANDEX="YANDEX",e.GAME_PIX="GAMEPIX",e.Y8="Y8",e.COOLMATH="COOLMATH",e.WEB="CUSTOM",e.PARTNER="PARTNER",e.VK_PLAY="VK_PLAY",e.PLAY_DECK="PLAYDECK",e.TELEGRAM="TELEGRAM",e.WG_PLAYGROUND="WG_PLAYGROUND",e.KONGREGATE="KONGREGATE",e.BEELINE="BEELINE",e.FOTOSTRANA="FOTOSTRANA",e.CUSTOM="CUSTOM",e.PLAYGAMA="PLAYGAMA",e.ANDROID="ANDROID",e.GOOGLE_PLAY="GOOGLE_PLAY",e.APP_GALLERY="APP_GALLERY",e.GALAXY_STORE="GALAXY_STORE",e.ONE_STORE="ONE_STORE",e.AMAZON_APPSTORE="AMAZON_APPSTORE",e.XIAOMI_GET_APPS="XIAOMI_GETAPPS",e.AP_TO_IDE="APTOIDE",e.RU_STORE="RUSTORE",e.UNKNOWN="UNKNOWN"})(Bn||(Bn={}));const bi={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,REACT_APP_API_URL:"https://sdk3.dev.tonlabs.io/api/account",REACT_APP_BUILD_TIME:"19.11.25 14:49",REACT_APP_GAME:"checkers_en",SSR:!1},Ei=e=>{const t=bi[e]||"";return["true","1","TRUE","True"].includes(t.toString())},Oi="checkers_en";Ei("REACT_APP_ARENA_MODE_ENABLED");const Pi=()=>Oi==="checkers_poddavki";var ie=(e=>(e.PLAYING="playing",e.DRAW="draw",e.LIGHT_WON="light_won",e.DARK_WON="dark_won",e))(ie||{}),R=(e=>(e.LIGHT="0",e.DARK="1",e))(R||{});class Gt{constructor(t,n){U(this,"data");U(this,"strategy");U(this,"_moves");U(this,"_status");this.data=t,this.strategy=n}get status(){return this._status??(this._status=this.strategy.status(this))}get moves(){return this._moves??(this._moves=this.strategy.moves(this))}clone(){return new Gt(this.serialize(),this.strategy)}serialize(){return{board:{...this.data.board},store:this.strategy.serializeStore(this.data.store),player:this.data.player,isMandatoryTaken:this.data.isMandatoryTaken}}movesChain(t){return this.strategy.movesChain(this,t)}move(t){this.data=this.strategy.move(this,t),this._moves=void 0,this._status=void 0}isValidMove(t){return this.strategy.isValidMove(this,t)}}const Ne=32,m=[];m[0]=1;for(let e=1;e<Ne;e++)m[e]=m[e-1]*2;const Hn=4294967295;function J(e,t){const n=t%Ne;return(e>>>n|e<<Ne-n&Hn)>>>0}function Y(e,t){const n=t%Ne;return(e<<n&Hn|e>>>Ne-n)>>>0}function kt(e){const t=[];for(let n=1;e;n<<=1)e&n&&(t.push(n>>>0),e^=n);return t}function be(e){return e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),e=(e+(e>>>4)&252645135)*16843009>>>24,e}const Te=[m[11],m[5],m[31],m[25],m[10],m[4],m[30],m[24],m[3],m[29],m[23],m[17],m[2],m[28],m[22],m[16],m[27],m[21],m[15],m[9],m[26],m[20],m[14],m[8],m[19],m[13],m[7],m[1],m[18],m[12],m[6],m[0]],Lt=new Map(Te.map((e,t)=>[e,t])),Re={toMove1D(e){const t=Lt.get(e.origin);if(t===void 0)throw new Error(`invalid move origin: ${e.origin}`);const n=Lt.get(e.destination);if(n===void 0)throw new Error(`invalid move destination: ${e.destination}`);const r=[];for(const i of kt(e.captures)){const s=Lt.get(i);s!==void 0&&r.push(s)}return{origin:t,destination:n,captures:r}},toEngineMove(e){const t=Te[e.origin];if(t===void 0)throw new Error(`invalid move origin: ${e.origin}`);const n=Te[e.destination];if(n===void 0)throw new Error(`invalid move destination: ${e.destination}`);let r=0;for(const i of e.captures){const s=Te[i];if(s===void 0)throw new Error(`invalid move capture: ${i}`);r|=s}return{origin:t,destination:n,captures:r}},toBoard1D(e){const t=[];for(const[n,r]of Te.entries()){Math.floor(n/4)%2===0&&t.push({dark:!1,piece:void 0,position:void 0});const i=!!(r&e.light),s=!!(r&e.dark),a=!!(r&e.king);t.push({dark:!0,position:n,piece:i||s?{player:i?R.LIGHT:R.DARK,king:a}:void 0}),Math.floor(n/4)%2!==0&&t.push({dark:!1,piece:void 0,position:void 0})}return t}},_i={moves:[],boards:[]};function Ai(e,t){return e.origin===t.origin&&e.destination===t.destination&&e.captures===t.captures}function Wn(e){const t=Math.floor(Math.sqrt(e.length)),n="-".repeat(1+t*4);let r=`${n}
`;for(const[i,s]of e.entries()){if(i%t===0&&(r+="|"),s.piece){let a=s.piece.player===R.LIGHT?"x":"o";a=s.piece.king?a.toUpperCase():a,r+=` ${a} |`}else r+="   |";i%t===t-1&&(r+=` 
${n}
`)}return r}class Si{constructor(t,n,r){U(this,"engine");U(this,"history");U(this,"_board");U(this,"_moves");U(this,"adapter");this.engine=t,this.history=n,this.adapter=r}get status(){return this.engine.status}get player(){return this.engine.data.player}get board(){return this._board??(this._board=this.adapter.toBoard1D(this.engine.data.board))}get isLightEmpty(){const t=this.engine.data.board.light;return typeof t=="number"?t===0:t.isZero()}get isDarkEmpty(){const t=this.engine.data.board.dark;return typeof t=="number"?t===0:t.isZero()}get moves(){return this._moves??(this._moves=this.engine.moves.map(t=>this.adapter.toMove1D(t)))}isValidMove(t){const n=this.adapter.toEngineMove(t);return this.engine.isValidMove(n)}move(t){if(!this.isValidMove(t))throw new Error(`invalid move: ${JSON.stringify(t)}`);const n=JSON.parse(JSON.stringify({player:this.engine.data.player,board:this.engine.data.board})),r=this.adapter.toEngineMove(t);this.engine.move(r),this.history.boards.push(this.board),this.history.moves.push({...t,before:n,after:JSON.parse(JSON.stringify({player:this.engine.data.player,board:this.engine.data.board}))}),this._board=void 0,this._moves=void 0}movesChain(t){const n=this.adapter.toEngineMove(t);return this.engine.movesChain(n).map(i=>this.adapter.toMove1D({captures:1,origin:1,destination:i}).destination)}asciiBoard(){return Wn(this.board)}}const Ee=m[18]|m[12]|m[6]|m[0],Mi=m[19]|m[13]|m[7]|m[1],Ii=m[26]|m[20]|m[14]|m[8];m[27]|m[21]|m[15]|m[9],m[2]|m[28]|m[22]|m[16];const wi=m[3]|m[29]|m[23]|m[17],Di=m[10]|m[4]|m[30]|m[24],Oe=m[11]|m[5]|m[31]|m[25],$n=m[18]|m[26]|m[2]|m[10],Vn=m[1]|m[9]|m[17]|m[25],Ni=~(Oe|$n),Ti=~(Oe|Vn),Ri=~(Ee|$n),xi=~(Ee|Vn),Ci=Ee|Mi|Ii,Gi=wi|Di|Oe;m[21]|m[28]|m[22],m[29]|m[22]|m[21]|m[14];const ki={[R.LIGHT]:Ee,[R.DARK]:Oe},Li={[R.LIGHT]:Oe,[R.DARK]:Ee},D={RANK_0:Ee,RANK_7:Oe,FORWARD_LEFT:Ni,FORWARD_RIGHT:Ti,BACKWARD_LEFT:Ri,BACKWARD_RIGHT:xi,LIGHT_START:Ci,DARK_START:Gi};class Ft{constructor(t){U(this,"intermediates");this.intermediates=t}getJumpers(){let t=J(this.intermediates.empty,7)&(this.intermediates.opponent&D.FORWARD_LEFT),n=J(t,7)&(this.intermediates.forward&D.FORWARD_LEFT);return t=J(this.intermediates.empty,1)&(this.intermediates.opponent&D.FORWARD_RIGHT),n|=J(t,1)&(this.intermediates.forward&D.FORWARD_RIGHT),t=Y(this.intermediates.empty,1)&(this.intermediates.opponent&D.BACKWARD_LEFT),n|=Y(t,1)&(this.intermediates.backward&D.BACKWARD_LEFT),t=Y(this.intermediates.empty,7)&(this.intermediates.opponent&D.BACKWARD_RIGHT),n|=Y(t,7)&(this.intermediates.backward&D.BACKWARD_RIGHT),n}getMovers(){let t=0;return this.intermediates.forward&&(t|=J(this.intermediates.empty,7)&this.intermediates.forward&D.FORWARD_LEFT,t|=J(this.intermediates.empty,1)&this.intermediates.forward&D.FORWARD_RIGHT),this.intermediates.backward&&(t|=Y(this.intermediates.empty,1)&this.intermediates.backward&D.BACKWARD_LEFT,t|=Y(this.intermediates.empty,7)&this.intermediates.backward&D.BACKWARD_RIGHT),t}getMovesFromOrigin(t){const n=[];if(t&this.intermediates.forward){const r=(Y(t&D.FORWARD_LEFT,7)&this.intermediates.empty)>>>0;r&&n.push({origin:t,destination:r,captures:0});const i=(Y(t&D.FORWARD_RIGHT,1)&this.intermediates.empty)>>>0;i&&n.push({origin:t,destination:i,captures:0})}if(t&this.intermediates.backward){const r=J(t&D.BACKWARD_LEFT,1)&this.intermediates.empty;r&&n.push({origin:t,destination:r,captures:0});const i=J(t&D.BACKWARD_RIGHT,7)&this.intermediates.empty;i&&n.push({origin:t,destination:i,captures:0})}return n}getMovesChainFromMove(t){const{origin:n,captures:r,destination:i}=t,s=this.getSingleJumpFromOrigin(n).filter(o=>o.captures&r).map(o=>({...o,chain:[o.destination]})),a=[];for(;s.length>0;){const o=s.pop();if(o===void 0)break;const f=this.applyUnfinishedCapture({...o,origin:n}).getSingleJumpFromOrigin(o.destination).filter(d=>d.captures&r);for(const d of f)s.push({origin:n,destination:d.destination,captures:o.captures|d.captures,chain:[...o.chain,d.destination]});f.length===0&&a.push(o)}return(a.filter(o=>o.origin&n&&o.destination&i)[0]||{}).chain||[]}getJumpsFromOrigin(t){const n=this.getSingleJumpFromOrigin(t),r=[];for(;n.length>0;){const i=n.pop();if(i===void 0)break;const a=this.applyUnfinishedCapture({...i,origin:t}).getSingleJumpFromOrigin(i.destination);for(const o of a)n.push({origin:t,destination:o.destination,captures:i.captures|o.captures});a.length===0&&r.push(i)}return r}getSingleJumpFromOrigin(t){const n=[];if(t&this.intermediates.forward){const r=Y(t&D.FORWARD_LEFT,7)&this.intermediates.opponent,i=(Y(r&D.FORWARD_LEFT,7)&this.intermediates.empty)>>>0;i&&n.push({origin:t,destination:i,captures:r});const s=Y(t&D.FORWARD_RIGHT,1)&this.intermediates.opponent,a=(Y(s&D.FORWARD_RIGHT,1)&this.intermediates.empty)>>>0;a&&n.push({origin:t,destination:a,captures:s})}if(t&this.intermediates.backward){const r=J(t&D.BACKWARD_LEFT,1)&this.intermediates.opponent,i=J(r&D.BACKWARD_LEFT,1)&this.intermediates.empty;i&&n.push({origin:t,destination:i,captures:r});const s=J(t&D.BACKWARD_RIGHT,7)&this.intermediates.opponent,a=J(s&D.BACKWARD_RIGHT,7)&this.intermediates.empty;a&&n.push({origin:t,destination:a,captures:s})}return n}applyUnfinishedCapture(t){return new Ft({forward:this.intermediates.forward&t.origin?this.intermediates.forward|t.destination:this.intermediates.forward,backward:this.intermediates.backward&t.origin?this.intermediates.backward|t.destination:this.intermediates.backward,opponent:this.intermediates.opponent&~t.captures,empty:this.intermediates.empty})}}const Jn={fromEngine(e){const{player:t,board:n}=e.data;return new Ft({forward:t===R.LIGHT?n.light:n.dark&n.king,backward:t===R.LIGHT?n.light&n.king:n.dark,opponent:t===R.LIGHT?n.dark:n.light,empty:~(n.light|n.dark)})}},Yn={player:R.DARK,board:{light:D.LIGHT_START,dark:D.DARK_START,king:0},store:{sinceCapture:0,sinceNonKingAdvance:0},isMandatoryTaken:!0},qn={serializeStore(e){return{...e}},status(e){return e.moves.length===0?e.data.player===R.LIGHT?ie.DARK_WON:ie.LIGHT_WON:e.data.store.sinceCapture>=40&&e.data.store.sinceNonKingAdvance>=40?ie.DRAW:ie.PLAYING},isValidMove(e,t){return e.moves.some(n=>Ai(t,n))},moves(e){const t=Jn.fromEngine(e),n=[],r=t.getJumpers();for(const s of kt(r))n.push(...t.getJumpsFromOrigin(s));if(e.data.isMandatoryTaken&&r)return n;const i=t.getMovers();for(const s of kt(i))n.push(...t.getMovesFromOrigin(s));return n},movesChain(e,t){if(!e.isValidMove(t))throw new Error(`invalid move: ${JSON.stringify(t)}`);return Jn.fromEngine(e).getMovesChainFromMove(t)},move(e,t){if(!e.isValidMove(t))throw new Error(`invalid move: ${JSON.stringify(t)}`);const n={...e.data.board},r={...e.data.store};return n.light&=~(t.origin|t.captures),n.dark&=~(t.origin|t.captures),n.king&=~(t.origin|t.captures),e.data.board.light&t.origin?(n.light|=t.destination,n.king|=t.destination&D.RANK_7):(n.dark|=t.destination,n.king|=t.destination&D.RANK_0),e.data.board.king&t.origin?(n.king|=t.destination,r.sinceNonKingAdvance+=1):r.sinceNonKingAdvance=0,t.captures?r.sinceCapture=0:r.sinceCapture+=1,{player:e.data.player===R.LIGHT?R.DARK:R.LIGHT,board:n,store:r,isMandatoryTaken:e.data.isMandatoryTaken}}},jt={setup(e){return new Gt({...Yn,...e},qn)}},Fi={setup(e,t){const n=jt.setup(e);return new Si(n,{..._i,...t},Re)}},Je=Number.MAX_SAFE_INTEGER-1e3,Ut=-Je,ji={[ie.LIGHT_WON]:R.LIGHT,[ie.DARK_WON]:R.DARK},zn=e=>{const t=e.status;if(t!==ie.PLAYING)return t===ie.DRAW?{eva:0}:e.data.player===ji[t]?{eva:Je}:{eva:Ut}},Xn=async({data:{engine:e,alpha:t,beta:n,depth:r},options:{evaluationFunction:i,quiescence:s}})=>{if(r===0)return s?Zn({data:{engine:e,alpha:t,beta:n},options:{evaluationFunction:i}}):i(e);for(const a of e.moves){const o=e.clone();o.move(a);const c=await Xn({data:{engine:o,alpha:{sum:n.sum,eva:-n.eva},beta:{sum:t.sum,eva:-t.eva},depth:r-1},options:{evaluationFunction:i,quiescence:s}});if(c.eva=-(Math.abs(c.eva)-.1)*Math.sign(c.eva),c.eva>=n.eva)return n;c.eva>t.eva&&(t=c)}return t};async function Zn({data:{engine:e,alpha:t,beta:n},options:{evaluationFunction:r}}){const i=r(e);if(i.eva>=n.eva)return n;i.eva>t.eva&&(t=i);for(const s of e.moves){if(!s.captures)continue;const a=e.clone();a.move(s);const o=await Zn({data:{engine:a,alpha:{sum:n.sum,eva:-n.eva},beta:{sum:t.sum,eva:-t.eva}},options:{evaluationFunction:r}});if(o.eva=-(Math.abs(o.eva)-.1)*Math.sign(o.eva),o.eva>=n.eva)return n;o.eva>t.eva&&(t=o)}return t}async function Ui({options:{maxDepth:e,evaluationFunction:t,quiescence:n=!0},engine:r}){let i={eva:Ut},s;for(const a of r.moves){const o=r.clone();o.move(a);const f=await Xn({data:{engine:o,alpha:{eva:Ut},beta:{eva:Je},depth:e-1},options:{evaluationFunction:t,quiescence:n}});f.eva=-f.eva,f.eva>=i.eva&&(i=f,s=a)}if(s===void 0)throw new Error("no available moves");return{move:s,evaluation:i}}const Qn={setup({adapter:e,strategy:t,options:n}){return async r=>{const i=await t({options:n,engine:r.engine});return{move:e.toMove1D(i.move),evaluation:i.evaluation}}}};async function Ki({engine:e}){if(e.moves.length===0)throw new Error("no valid moves");const t=Math.floor(Math.random()*e.moves.length);return{move:e.moves[t],evaluation:{sum:1110,eva:-0}}}const Bi=e=>zn(e)??Hi(e),er=50,tr=50,nr=20;function Hi(e){const{player:t}=e.data,n=t===R.LIGHT?e.data.board.light:e.data.board.dark,r=t===R.LIGHT?e.data.board.dark:e.data.board.light,i=n&e.data.board.king,s=r&e.data.board.king,a=be(n),o=be(r),c=be(i),f=be(s),d=be(n&ki[t]),g=be(r&Li[t]),p=a*er+c*tr+d*nr,b=o*er+f*tr+g*nr;return{sum:p+b,eva:p-b}}const Wi={random(){return Qn.setup({adapter:Re,strategy:Ki,options:void 0})},alphaBeta(e){const t={maxDepth:e.maxDepth??4,quiescence:e.quiescence??!0,evaluationFunction:e.evaluationFunction??Bi};return Qn.setup({adapter:Re,strategy:Ui,options:t})}};R.LIGHT;const rr=["a","b","c","d","e","f","g","h"],Ye=e=>{const t=Math.floor(e/4),n=(e*2+1-t%2)%8;return`${rr[n]}${8-t}`},Kt=e=>{const t=rr.indexOf(e[0]),n=8-Number(e[1]);return(t+n%2-1)/2+n*4},$i=e=>{var t;return{captures:((t=e.captures)==null?void 0:t.map(Ye))??[],from:Ye(e.origin),to:Ye(e.destination),_base:!0}},Vi=e=>{var t;return{captures:((t=e.captures)==null?void 0:t.map(Kt))??[],origin:Kt(e.from),destination:Kt(e.to)}},ir=e=>{const t=Object.keys(e).includes("_base")?e:$i(e),n=t.captures.join(":");return t.captures.length?`${t.from}${t.to}-${n}`:`${t.from}${t.to}`},Ji=e=>{const n=(e.split("-")[1]||"").split(":").filter(r=>!!r);return{from:`${e[0]}${e[1]}`,to:`${e[2]}${e[3]}`,captures:n,_base:!0}};var sr=(e=>(e[e.Negamax=0]="Negamax",e[e.MCTS=1]="MCTS",e))(sr||{});const ar=jt,or=qn,Yi=e=>{if(e.board===void 0)throw new Error("state?.G.board is undefined");const t=Wn(Re.toBoard1D(e.board));console.log(t)},ur={setup:()=>({...Yn}),moves:{makeMove:({G:e,playerID:t},n)=>{e.player=t;const r=ar.setup(e);try{const i=or.move(r,n);e.board=i.board,e.player=i.player,e.store=i.store}catch{return Yi(e),"INVALID_MOVE"}}},turn:{minMoves:1,maxMoves:1},ai:{enumerate:(e,t,n)=>{const r=ar.setup({...e,player:n});return or.moves(r).map(s=>({move:"makeMove",args:[s]}))}},endIf:({G:e,ctx:t})=>{const n=jt.setup({...e,player:t.currentPlayer});if(n.moves.length===0)return{winner:n.data.player===R.LIGHT?"1":"0"};if(n.data.store.sinceCapture>=40&&n.data.store.sinceNonKingAdvance>=40)return{draw:!0}}},qi=e=>({...ur,setup:()=>({...e.engine.data}),turn:{...ur.turn,order:e.engine.data.player===R.LIGHT?Mt.CUSTOM(["0","1"]):Mt.CUSTOM(["1","0"])}}),Bt=e=>{if(e===null||typeof e!="object")return e;if(Array.isArray(e)){const n=[];for(let r=0;r<e.length;r++)n[r]=Bt(e[r]);return n}const t={};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n];t[n]=Bt(r)}return t},cr=Wi,zi=Fi,xe=class xe{constructor(t,n={moves:[]}){U(this,"initialState");U(this,"nativeEngine",null);U(this,"lastSearchEva",null);U(this,"movesChainList",[]);const r={isMandatoryTaken:xe.isMandatoryTaken,...t,...Pi()};this.initialState=Bt(r),this.nativeEngine=zi.setup(r,n)}static fromFen(t){const n=JSON.parse(t);return new xe(n)}get isLightEmpty(){return this.nativeEngine.engine.data.board.light===0}get isDarkEmpty(){return this.nativeEngine.engine.data.board.dark===0}get isEveryoneHasKing(){const t=this.nativeEngine.engine.data.board,n=t.light&t.king,r=t.dark&t.king;return n!==0&&r!==0}get lightFiguresCnt(){return this.nativeEngine.engine.data.board.light.toString(2).split("1").length-1}get darkFiguresCnt(){return this.nativeEngine.engine.data.board.dark.toString(2).split("1").length-1}movesChain(t){return(this.movesChainList||[])[t]||[]}move(t){const n=typeof t=="string"?Ji(t):t,r=Vi(n),i=this.nativeEngine.movesChain(r);this.movesChainList||(this.movesChainList=[]),this.movesChainList.push(i.map(Ye)),this.nativeEngine.move(r)}normalizeMove(t){const{action:n,percent:r}=t,i=n.payload.args[0];return{move:ir(Re.toMove1D(i)),evaluation:{sum:100,eva:2*r-100}}}async calcMove(t){var n,r,i;try{if(t.algorithm===sr.Negamax){const s=t.depth?cr.alphaBeta({maxDepth:t.depth,quiescence:!0}):cr.random(),{move:a,evaluation:o}=await s(this.nativeEngine);return{move:ir(a),evaluation:{...o,eva:o.eva}}}else{const s=qi(this.nativeEngine),a=mi({game:s,debug:!1}),o=new ei({game:s,enumerate:(n=s.ai)==null?void 0:n.enumerate,iterations:t.iterations,playoutDepth:t.playoutDepth,isInstantForSingleAction:t.isInstantForSingleAction,isAsync:!0}),c=this.nativeEngine.player===R.LIGHT?"0":"1",f=await o.play(a.getState(),c,t.timeLimit,(r=t.interval)==null?void 0:r.updateScoreInterval,(i=t.interval)==null?void 0:i.updateScoreCallback);return this.normalizeMove(f)}}catch(s){return console.error("workerEngine calcMove",s),{move:"-",evaluation:zn(this.nativeEngine.engine)||{sum:0,eva:Je}}}}};U(xe,"isMandatoryTaken",!0);let Ht=xe,Pe;onmessage=function(e){const t=typeof e.data=="string"?JSON.parse(e.data):e.data;Pe=Ht.fromFen(typeof t.fen=="string"?t.fen:JSON.stringify(t.fen));const n={...t.aiConfig,...t.aiConfig.interval&&{interval:{updateScoreCallback:r=>{postMessage({type:"update",data:{...Pe.normalizeMove(r),chain:[]}})},updateScoreInterval:t.aiConfig.interval.updateScoreInterval}}};Pe.calcMove(n).then(r=>{try{Pe.move(r.move)}catch{}const i=Pe.movesChain(Pe.nativeEngine.history.moves.length-1);postMessage({type:"result",data:{...r,chain:i}})})}})();
